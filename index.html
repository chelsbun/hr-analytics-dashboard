<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HR Analytics Dashboard ‚Äì Chelsea Bonyata</title>
  <!-- Tailwind CSS CDN for SaaS polish -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/chelsbun/hr-analytics-dashboard/favicon.ico">
  <style>
    .fade-in { animation: fadein .6s; }
    @keyframes fadein { from { opacity:0; transform: translateY(16px);} to{ opacity:1; transform: none; } }
    .btn-hr-analytic {
      background: linear-gradient(to right, #6366f1, #a21caf);
      color: white;
      padding: 0.9em 1.6em;
      border-radius: 1em;
      font-weight: 600;
      font-size: 1.1em;
      box-shadow: 0 2px 12px #6366f111;
      transition: all 0.13s;
      width: 100%;
      margin-bottom: 0.5em;
    }
    .btn-hr-analytic:hover { filter: brightness(1.05); transform: scale(1.025);}
    .btn-hr-analytic:active { filter: brightness(0.95); transform: scale(0.97);}
    .btn-connect:active { transform: scale(0.97);}
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-400 to-purple-500 min-h-screen py-6">
  <div class="max-w-5xl mx-auto px-2 sm:px-6 lg:px-8">
    <!-- Connection Status -->
    <div id="connectionStatus" class="fixed top-5 right-5 z-50 px-5 py-2 rounded-full text-sm font-semibold shadow-md bg-gray-900 text-white fade-in">Database Disconnected</div>
    <!-- Header -->
    <div class="bg-white/80 backdrop-blur-md rounded-2xl shadow-xl py-8 px-6 md:px-10 mb-8 mt-2 text-center fade-in">
      <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 mb-1">HR Analytics Dashboard</h1>
      <div class="text-gray-600 mb-3 text-base">Demonstrating Advanced SQL &amp; Workday-Ready Analytics</div>
      <div class="font-medium text-indigo-500 mb-1">Created by Chelsea Bonyata <span class="text-xs text-gray-400">| Insperity Software Engineer Candidate</span></div>
      <div class="flex flex-col md:flex-row gap-2 items-center justify-center mt-2">
        <a href="mailto:chelseabonyata@gmail.com" class="text-indigo-700 hover:underline">Email</a>
        <span class="hidden md:inline text-gray-300">|</span>
        <a href="https://www.linkedin.com/in/chelsea-bonyata-477236152/" class="text-indigo-700 hover:underline">LinkedIn</a>
        <span class="hidden md:inline text-gray-300">|</span>
        <a href="https://github.com/chelsbun" class="text-indigo-700 hover:underline">GitHub</a>
      </div>
    </div>

    <!-- Database Connection -->
    <div class="bg-white rounded-2xl shadow-lg py-8 px-6 md:px-12 mb-8 fade-in">
      <h3 class="text-lg font-bold mb-2 text-indigo-700">Database Configuration</h3>
      <div class="mb-3 text-sm text-gray-500">Your Supabase connection details:</div>
      <div class="flex flex-col md:flex-row gap-3 mb-3">
        <input type="url" id="supabaseUrl" class="w-full md:w-1/2 bg-gray-100 rounded-md px-4 py-2 text-gray-700 border border-gray-300 focus:ring-2 focus:ring-indigo-400 transition" value="https://jxohlvotednnxnyltibw.supabase.co" readonly>
        <input type="password" id="supabaseKey" class="w-full md:w-1/2 bg-gray-100 rounded-md px-4 py-2 text-gray-700 border border-gray-300 focus:ring-2 focus:ring-indigo-400 transition" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4b2hsdm90ZWRubnhueWx0aWJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1ODY1OTQsImV4cCI6MjA3MDE2MjU5NH0.gkUyFXw1Am6hZSRNPxgoEUNL8jteeoEtF8KWwxykrOY" readonly>
      </div>
      <button class="btn-connect w-full md:w-auto mt-3 bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white px-6 py-3 font-semibold rounded-xl shadow transition text-lg" onclick="connectToDatabase()">Connect to Database</button>
    </div>

    <!-- Query Controls -->
    <div class="bg-white rounded-2xl shadow-lg py-8 px-6 md:px-12 mb-8 fade-in" id="queryControls" style="display: none;">
      <h3 class="text-lg font-bold mb-2 text-indigo-700">Run Advanced SQL Analyses</h3>
      <div class="mb-3 text-sm text-gray-500">Click any button to demonstrate complex SQL skills:</div>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
        <button class="btn-hr-analytic" onclick="runDataQualityAudit()">üîç Data Quality Audit</button>
        <button class="btn-hr-analytic" onclick="runCostAnalysis()">üìä Benefits Cost Analysis</button>
        <button class="btn-hr-analytic" onclick="runDemographicAnalysis()">üë• Demographic Analysis</button>
        <button class="btn-hr-analytic" onclick="showReportWriter()">üìã Report Writer &amp; Calculated Fields</button>
      </div>
      <!-- Real Employee CSV Import -->
      <div class="flex flex-col md:flex-row items-center gap-3">
        <label class="text-base font-semibold text-indigo-700 mb-2 md:mb-0">Upload Employees CSV:</label>
        <input type="file" id="empCSV" accept=".csv" class="bg-gray-100 rounded-lg p-2" />
        <button class="btn-hr-analytic" onclick="handleEmpCSVImport()">‚¨ÜÔ∏è Import Employees (Real)</button>
      </div>
    </div>

    <!-- Loading Indicator (centered, overlays results) -->
    <div id="loading" class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 hidden">
      <div class="flex flex-col items-center">
        <svg class="animate-spin h-12 w-12 text-indigo-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <div class="text-lg text-indigo-700 font-semibold">Processing...</div>
      </div>
    </div>

    <!-- Toast Message -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 z-50 hidden">
      <div id="toastMsg" class="px-6 py-3 rounded-lg shadow-lg text-white font-medium text-lg bg-indigo-600"></div>
    </div>

    <!-- Results Container -->
    <div id="results"></div>
  </div>

  <!-- Supabase and main JS logic -->
  <script type="module">
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2'

    let supabase = null;
    let isConnected = false;

    // UI Helper Functions
    window.connectToDatabase = connectToDatabase;
    window.runDataQualityAudit = runDataQualityAudit;
    window.runCostAnalysis = runCostAnalysis;
    window.runDemographicAnalysis = runDemographicAnalysis;
    window.showReportWriter = showReportWriter;
    window.handleEmpCSVImport = handleEmpCSVImport;

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toastMsg');
      toastMsg.textContent = message;
      toastMsg.className = `px-6 py-3 rounded-lg shadow-lg text-white font-medium text-lg ${type === 'success' ? 'bg-indigo-600' : 'bg-red-500'}`;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 2200);
    }
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }
    function updateConnectionStatus(connected) {
      const status = document.getElementById('connectionStatus');
      if (connected) {
        status.textContent = 'Database Connected';
        status.className = "fixed top-5 right-5 z-50 px-5 py-2 rounded-full text-sm font-semibold shadow-md bg-green-600 text-white fade-in";
      } else {
        status.textContent = 'Database Disconnected';
        status.className = "fixed top-5 right-5 z-50 px-5 py-2 rounded-full text-sm font-semibold shadow-md bg-gray-900 text-white fade-in";
      }
    }

    // Connect to Supabase
    async function connectToDatabase() {
      const url = document.getElementById('supabaseUrl').value;
      const key = document.getElementById('supabaseKey').value;
      try {
        supabase = createClient(url, key);
        // Test a simple query to validate connection
        showLoading(true);
        const { data, error } = await supabase.from('clients').select('*').limit(1);
        showLoading(false);
        if (error) throw error;
        isConnected = true;
        updateConnectionStatus(true);
        document.getElementById('queryControls').style.display = 'block';
        showToast('Connected to Supabase database!');
      } catch (e) {
        showLoading(false);
        updateConnectionStatus(false);
        showToast('Failed to connect to Supabase.', 'error');
      }
    }

    // Run Data Quality Audit Query
    async function runDataQualityAudit() {
      if (!isConnected) return showToast('Connect to the database first!', 'error');
      showLoading(true);
      const sql = `
      WITH data_quality_issues AS (
        SELECT 
          'Missing/Invalid SSN' as issue_type,
          c.company_name,
          e.first_name || ' ' || e.last_name as employee_name,
          'HIGH' as priority
        FROM employees e
        JOIN clients c ON e.client_id = c.client_id
        WHERE e.ssn IS NULL

        UNION ALL

        SELECT 
          'Terminated Employee Active Benefits',
          c.company_name,
          e.first_name || ' ' || e.last_name,
          'HIGH'
        FROM employees e
        JOIN clients c ON e.client_id = c.client_id
        JOIN enrollments en ON e.employee_id = en.employee_id
        WHERE e.status = 'TERMINATED' AND en.status = 'ACTIVE'
      )
      SELECT 
        company_name,
        issue_type,
        COUNT(*) as issue_count,
        STRING_AGG(employee_name, '; ') as affected_employees
      FROM data_quality_issues
      GROUP BY company_name, issue_type;`;

      try {
        const { data, error } = await supabase.rpc('run_sql', { query: sql });
        showLoading(false);
        if (error) throw error;
        renderResultsTable(data, 'Data Quality Audit Results');
        showToast('Audit complete!');
      } catch (e) {
        showLoading(false);
        showToast('Failed to run audit: ' + e.message, 'error');
      }
    }

    // Run Cost Analysis
    async function runCostAnalysis() {
      if (!isConnected) return showToast('Connect to the database first!', 'error');
      showLoading(true);
      const sql = `
        SELECT c.company_name, b.plan_type, 
               EXTRACT(YEAR FROM en.enrollment_date) AS year,
               SUM(en.employee_premium + en.employer_premium) AS total_cost
        FROM enrollments en
        JOIN employees e ON en.employee_id = e.employee_id
        JOIN clients c ON e.client_id = c.client_id
        JOIN benefits_plans b ON en.plan_id = b.plan_id
        WHERE en.status = 'ACTIVE'
        GROUP BY c.company_name, b.plan_type, year
        ORDER BY c.company_name, b.plan_type, year;
      `;
      try {
        const { data, error } = await supabase.rpc('run_sql', { query: sql });
        showLoading(false);
        if (error) throw error;
        renderResultsTable(data, 'Benefits Cost Analysis');
        showToast('Cost analysis complete!');
      } catch (e) {
        showLoading(false);
        showToast('Failed to run cost analysis: ' + e.message, 'error');
      }
    }

    // Demographic Analysis
    async function runDemographicAnalysis() {
      if (!isConnected) return showToast('Connect to the database first!', 'error');
      showLoading(true);
      const sql = `
        SELECT c.company_name, 
          CASE 
            WHEN e.salary < 50000 THEN '<$50k'
            WHEN e.salary BETWEEN 50000 AND 99999 THEN '$50-100k'
            WHEN e.salary BETWEEN 100000 AND 149999 THEN '$100-150k'
            ELSE '>$150k'
          END AS salary_band,
          COUNT(*) AS employee_count
        FROM employees e
        JOIN clients c ON e.client_id = c.client_id
        GROUP BY c.company_name, salary_band
        ORDER BY c.company_name, salary_band;
      `;
      try {
        const { data, error } = await supabase.rpc('run_sql', { query: sql });
        showLoading(false);
        if (error) throw error;
        renderResultsTable(data, 'Demographic Analysis');
        showToast('Demographic analysis complete!');
      } catch (e) {
        showLoading(false);
        showToast('Failed to run demographic analysis: ' + e.message, 'error');
      }
    }

    // Report Writer (Demo)
    function showReportWriter() {
      renderResultsTable(null, 'Workday Report Writer &amp; Calculated Fields', `
        <div class="flex flex-col gap-3">
          <div>
            <label class="font-semibold">Report Name:</label>
            <input type="text" class="w-full bg-gray-100 rounded-md px-3 py-2 border border-gray-300 mt-1" placeholder="e.g., Benefits Cost Analysis by Department">
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
            <div>
              <label class="font-semibold">Employee Fields</label>
              <ul class="text-sm text-gray-600 list-disc ml-5">
                <li>Employee ID</li>
                <li>Full Name</li>
                <li>Department</li>
                <li>Job Title</li>
                <li>Hire Date</li>
                <li>Salary</li>
              </ul>
            </div>
            <div>
              <label class="font-semibold">Benefits Fields</label>
              <ul class="text-sm text-gray-600 list-disc ml-5">
                <li>Plan Type</li>
                <li>Employee Premium</li>
                <li>Employer Premium</li>
                <li>Enrollment Date</li>
                <li>Coverage Level</li>
              </ul>
            </div>
            <div>
              <label class="font-semibold">Company Fields</label>
              <ul class="text-sm text-gray-600 list-disc ml-5">
                <li>Company Name</li>
              </ul>
            </div>
          </div>
          <div class="flex gap-3 mt-4">
            <button onclick="generateReport()" class="btn-hr-analytic">üöÄ Generate Report</button>
            <button onclick="exportReport()" class="btn-hr-analytic">üìÅ Export to Excel</button>
            <button onclick="scheduleReport()" class="btn-hr-analytic">‚è∞ Schedule Report</button>
          </div>
          <div class="mt-4 border-t pt-4 text-center text-gray-500 text-sm">* This is a live simulation of Workday‚Äôs custom report writer, with advanced calculated fields.</div>
        </div>
      `);
    }

    // REAL Employees CSV Import (the magic)
    async function handleEmpCSVImport() {
      if (!isConnected) return showToast('Connect to the database first!', 'error');
      const fileInput = document.getElementById('empCSV');
      const file = fileInput.files[0];
      if (!file) return showToast('Please select a CSV file to import.', 'error');

      showLoading(true);
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async function(results) {
          try {
            // Remove empty-string fields, convert number fields, parse dates as needed
            let cleanRows = results.data.map(row => {
              // Remove fields not in table schema
              let allowed = [
                'employee_id', 'client_id', 'ssn', 'first_name', 'last_name', 'hire_date',
                'birth_date', 'department', 'job_title', 'salary', 'manager_id',
                'status', 'termination_date', 'created_date'
              ];
              let obj = {};
              allowed.forEach(key => {
                if (row[key] !== undefined) obj[key] = row[key] === "" ? null : row[key];
              });
              // Parse numbers
              obj.employee_id = obj.employee_id ? Number(obj.employee_id) : null;
              obj.client_id = obj.client_id ? Number(obj.client_id) : null;
              obj.salary = obj.salary ? Number(obj.salary) : null;
              obj.manager_id = obj.manager_id ? Number(obj.manager_id) : null;
              return obj;
            });

            // Filter out totally empty rows (sometimes parser makes an empty trailing row)
            cleanRows = cleanRows.filter(r => r.employee_id && r.first_name);

            if (!cleanRows.length) throw new Error('No valid employees found in the CSV.');

            // Insert or upsert
            const { data, error } = await supabase.from('employees').upsert(cleanRows, { onConflict: ['employee_id'] });

            showLoading(false);
            if (error) throw error;

            showToast(`${cleanRows.length} employees imported/updated successfully!`);
          } catch (err) {
            showLoading(false);
            showToast('Import failed: ' + err.message, 'error');
          }
        },
        error: function(err) {
          showLoading(false);
          showToast('CSV Parse error: ' + err.message, 'error');
        }
      });
    }

    // Helper: Render Table or HTML
    function renderResultsTable(data, title = '', extraHtml = '') {
      let html = '';
      if (title) {
        html += `<div class="text-2xl font-bold mb-5 text-indigo-800">${title}</div>`;
      }
      if (extraHtml) {
        html += `<div class="mb-5">${extraHtml}</div>`;
      }
      if (data && Array.isArray(data) && data.length) {
        const columns = Object.keys(data[0]);
        html += `<div class="overflow-x-auto rounded-xl shadow bg-white">
          <table class="min-w-full text-left text-gray-900 border-separate border-spacing-y-2">
            <thead class="bg-indigo-100 text-indigo-800">
              <tr>${columns.map(col => `<th class="py-2 px-4 font-bold">${col.replace(/_/g,' ')}</th>`).join('')}</tr>
            </thead>
            <tbody>
              ${data.map(row => `<tr>${columns.map(col =>
                `<td class="py-2 px-4 bg-gray-50 rounded-lg">${String(row[col] ?? '')}</td>`
              ).join('')}</tr>`).join('')}
            </tbody>
          </table>
        </div>`;
      } else if (!extraHtml) {
        html += `<div class="text-gray-500 italic py-8 text-center">No data found.</div>`;
      }
      document.getElementById('results').innerHTML = `<div class="bg-white rounded-2xl shadow-xl p-7 my-7 fade-in">${html}</div>`;
    }
  </script>
</body>
</html>
